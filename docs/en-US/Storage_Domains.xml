<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "REST_API_Guide.ent">
%BOOK_ENTITIES;
]>
<chapter id="chap-REST_API_Guide-Storage_Domains">
  <title>Storage Domains</title>
  <para>
    The storage domain specific elements which may be contained in the storage domain description are as follows:
  </para>
  <note>
    <title>Element property icons</title>
    <para>
      The icons used in the properties column of this table are described in <xref linkend="table-Property_Icons" />
    </para>
  </note> 

  <para>
    <informaltable frame="none">
      <tgroup cols="4">
        <colspec colwidth="4*"/>
        <colspec colwidth="4*"/>
        <colspec colwidth="6*"/>
        <colspec colwidth="2*" colname="prop"/>
        <thead>
          <row>
            <entry>Element</entry>
            <entry>Type</entry>
            <entry>Description</entry>
            <entry>Properties</entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry><literal>type</literal></entry>
            <entry>One of <literal>data</literal>, <literal>iso</literal> or <literal>export</literal></entry>
            <entry>The storage domain type</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/required.png" format="PNG" /></imageobject></inlinemediaobject><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
          <row>
            <entry><literal>status</literal></entry>
            <entry>One of <literal>ACTIVE</literal>, <literal>INACTIVE</literal>, <literal>LOCKED</literal>, <literal>MIXED</literal>, <literal>UNATTACHED</literal> and <literal>UNINITIALIZED</literal></entry>
            <entry>The storage domain status</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
          <row>
            <entry><literal>storage</literal></entry>
            <entry>complex</entry>
            <entry>Describes the underlying storage of the storage domain. For more information see <xref linkend="sect-REST_API_Guide-Storage_Domains-Storage_Types"/>.</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/required.png" format="PNG" /></imageobject></inlinemediaobject><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
          <row>
            <entry><literal>master</literal></entry>
            <entry>boolean: true or false</entry>
            <entry><literal>true</literal> if this is the master storage domain of a data center</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
          <row>
            <entry><literal>host</literal></entry>
            <entry>complex</entry>
            <entry>A reference to the host on which this storage domain should be initialized. The only restriction on this host is that it should have access to the physical storage specified.</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/required.png" format="PNG" /></imageobject></inlinemediaobject><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
          <row>
            <entry><literal>available</literal></entry>
            <entry>integer</entry>
            <entry>Space available in bytes</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
          <row>
            <entry><literal>used</literal></entry>
            <entry>integer</entry>
            <entry>Space used in bytes</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
          <row>
            <entry><literal>committed</literal></entry>
            <entry>integer</entry>
            <entry>Space committed in bytes</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
          <row>
            <entry><literal>storage_format</literal></entry>
            <entry>One of <literal>v1</literal> or <literal>v2</literal></entry>
            <entry>Describes the storage format version for the storage domain</entry>
            <entry><inlinemediaobject><imageobject><imagedata fileref="images/required.png" format="PNG" /></imageobject></inlinemediaobject><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>
  </para>

  <para>
    For example:
  </para>

  <screen>
&lt;storage_domain id="fabe0451-701f-4235-8f7e-e20e458819ed"
  href="/rhevm-api/storagedomains/fabe0451-701f-4235-8f7e-e20e458819ed"&gt;
    &lt;name&gt;images0&lt;/name&gt;
    &lt;type&gt;data&lt;/type&gt;
    &lt;status&gt;ACTIVE&lt;/status&gt;
    &lt;storage&gt;
        &lt;type&gt;nfs&lt;/type&gt;
        &lt;address&gt;172.31.0.6&lt;/address&gt;
        &lt;path&gt;/exports/RHEVX/images/0&lt;/path&gt;
    &lt;/storage&gt;
    &lt;master&gt;true&lt;/master&gt;
    &lt;available&gt;156766306304&lt;/available&gt;
    &lt;used&gt;433791696896&lt;/used&gt;
    &lt;committed&gt;617401548800&lt;/committed&gt;
    &lt;storage_format&gt;v1&lt;/storage_format&gt;
&lt;/storage_domain&gt;
  </screen>

  <para>
    When creating a new storage domain, the <literal>name</literal>, <literal>type</literal>, <literal>storage</literal> and <literal>host</literal> elements are required. The <literal>host</literal> may be identified by either <literal>id</literal> or <literal>name</literal>. Only the <literal>name</literal> element may be updated post-creation.
  </para>

  <para>
    Once a storage domain has been initialized it can be attached to a data center. See <xref linkend="sect-REST_API_Guide-Data_Centers-Attached_Storage_Domains"/>.
  </para>
  <section id="sect-REST_API_Guide-Storage_Domains-Storage_Types">
    <title>Storage types</title>
	<para>The <literal>storage</literal> element has a <literal>type</literal> element with the physical storage type and a number of elements specific to that storage type.</para>

    <section id="sect-REST_API_Guide-Storage_Domains-Storage_Types-NFS">
      <title>
        NFS
      </title>
      <para>The <literal>nfs</literal> specific elements in a <literal>storage</literal> description are:</para>

      <informaltable frame="none">
        <tgroup cols="4">
          <colspec colwidth="4*"/>
          <colspec colwidth="4*"/>
          <colspec colwidth="6*"/>
          <colspec colwidth="2*" colname="prop"/>
          <thead>
            <row>
              <entry>Element</entry>
              <entry>Type</entry>
              <entry>Description</entry>
              <entry>Properties</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry><literal>address</literal></entry>
              <entry>string</entry>
              <entry>The host name or IP address of the NFS server</entry>
              <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
            </row>
            <row>
              <entry><literal>path</literal></entry>
              <entry>string</entry>
              <entry>The path of NFS mountable directory on the server</entry>
              <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
    </section>
  
    <section id="sect-REST_API_Guide-Storage_Domains-Storage_Types-iSCSI_and_FCP">
      <title>
        iSCSI and FCP
      </title>

      <para>
        The <literal>iscsi</literal> and <literal>fcp</literal> specific elements in a <literal>storage</literal> description are:
      </para>
  
      <informaltable frame="none">
        <tgroup cols="4">
          <colspec colwidth="4*"/>
          <colspec colwidth="4*"/>
          <colspec colwidth="6*"/>
          <colspec colwidth="2*" colname="prop"/>
          <thead>
            <row>
              <entry>Element</entry>
              <entry>Type</entry>
              <entry>Description</entry>
              <entry>Properties</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry><literal>logical_unit id</literal></entry>
              <entry>complex</entry>
              <entry>A storage domain may be composed of multiple iSCSI or FCP logical units</entry>
              <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
            </row>
            <row>
              <entry><literal>volume_group id</literal></entry>
              <entry>complex</entry>
              <entry>Alternatively, a storage domain may be based on a single LVM Volume Group which, in turn, may be composed of multiple iSCSI or FCP logical units</entry>
              <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>

      <para>
        See <xref linkend="sect-REST_API_Guide-Hosts-Storage"/> for more details.
      </para>

      <para>
        In the case of iSCSI, if a <literal>logical_unit</literal> description also contains details of the iSCSI target containing the LUN in question, the target will be automatically logged into when the storage domain is created.
      </para>

    </section>
  
    <section id="sect-REST_API_Guide-Storage_Domains-Storage_Types-LOCAL">
      <title>
        LOCAL
      </title>
      <para>The <literal>local</literal> specific elements in a <literal>storage</literal> description are:</para>
      <informaltable frame="none">
        <tgroup cols="4">
          <colspec colwidth="4*"/>
          <colspec colwidth="4*"/>
          <colspec colwidth="6*"/>
          <colspec colwidth="2*" colname="prop"/>
          <thead>
            <row>
              <entry>Element</entry>
              <entry>Type</entry>
              <entry>Description</entry>
              <entry>Properties</entry>
            </row>
          </thead>
          <tbody>
              <row>
                <entry><literal>path</literal></entry>
                <entry>string</entry>
                <entry>The path of local storage domain on the host</entry>
                <entry><inlinemediaobject><imageobject><imagedata fileref="images/locked.png" format="PNG" /></imageobject></inlinemediaobject></entry>
              </row>
            </tbody>
          </tgroup>
        </informaltable>
      
        <para>A <literal>local</literal> storage domain requires a data center with <literal>storage_type</literal> set to LOCAL (see <xref linkend="chap-REST_API_Guide-Data_Centers"/>). This data center only contains a single host cluster, and the host cluster only contains a single host.</para>
    </section>
  </section>
  
  <section id="sect-REST_API_Guide-Data_Centers-Files">
    <title>
      Files
    </title>
    <para>
       The files sub-collection under each storage domain provides a way for clients to list available files. This sub-collection is specifically targeted to ISO storage domains, which contain ISO images and virtual floppy disks (VFDs) that an administrator uploads through Red Hat Enterprise Virtualization Manager.
    </para>
    <para>
      The addition of a CD-ROM device to a VM requires an ISO image from the files sub-collection of an ISO storage domain. See <xref linkend="chap-REST_API_Guide-VMs"/> for details.
    </para>

    <screen>
GET /rhevm-api/storagedomains/00f0d9ce-da15-4b9e-9e3e-3c898fa8b6da/files HTTP/1.1
Accept: application/xml

&lt;files&gt;
    &lt;file id="en_winxp_pro_with_sp2.iso"
      href="/rhevm-api/storagedomains/00f0d9ce-da15-4b9e-9e3e-3c898fa8b6da/files/
      en_winxp_pro_with_sp2.iso"&gt;
        &lt;name&gt;en_winxp_pro_with_sp2.iso&lt;/name&gt;
        &lt;type&gt;iso&lt;/type&gt;
        &lt;storage_domain id="00f0d9ce-da15-4b9e-9e3e-3c898fa8b6da"
          href="/rhevm-api/storagedomains/00f0d9ce-da15-4b9e-9e3e-3c898fa8b6da"/&gt;
    &lt;/file&gt;
    &lt;file id="boot.vfd"
      href="/rhevm-api/storagedomains/00f0d9ce-da15-4b9e-9e3e-3c898fa8b6da/files/boot.vfd"&gt;
        &lt;name&gt;boot.vfd&lt;/name&gt;
        &lt;type&gt;vfd&lt;/type&gt;
        &lt;storage_doman id="00f0d9ce-da15-4b9e-9e3e-3c898fa8b6da"
          href="/rhevm-api/storagedomains/00f0d9ce-da15-4b9e-9e3e-3c898fa8b6da"/&gt;
    &lt;/file&gt;
&lt;/files&gt;
    </screen>

    <para>
      Like other resources, files have opaque <literal>id</literal> and <literal>href</literal> attributes. The <literal>name</literal> element actually contains the filename.
    </para>
  </section>

  <section id="sect-REST_API_Guide-Storage_Domains-Import_Existing">
    <title>
      Importing Existing Storage Domains
    </title>

    <para>
      As a special case, you may remove an ISO or Export storage domain from one Red Hat Enterprise Virtualization Manager instance (without re-formatting the underlying storage) and import it into another instance. Importing is achieved similarly to adding a new storage domain, except that the <literal>name</literal> is ignored and not required.
    </para>

    <screen>
POST /rhevm-api/storagedomains HTTP/1.1
Accept: application/xml
Content-Type: application/xml

&lt;storage_domain&gt;
    &lt;type&gt;export&lt;/type&gt;
    &lt;storage&gt;
        &lt;type&gt;nfs&lt;/type&gt;
        &lt;address&gt;172.31.0.6&lt;/address&gt;
        &lt;path&gt;/exports/RHEVX/export-domain&lt;/path&gt;
    &lt;/storage&gt;
    &lt;host id="2ab5e1da-b726-4274-bbf7-0a42b16a0fc3"/&gt;
&lt;/storage_domain&gt;

HTTP/1.1 201 Created
Location: http://{host}/storagedomains/fabe0451-701f-4235-8f7e-e20e458819ed
Content-Type: application/xml

&lt;storage_domain id="fabe0451-701f-4235-8f7e-e20e458819ed"
  href="/rhevm-api/storagedomains/fabe0451-701f-4235-8f7e-e20e458819ed"&gt;
    &lt;name&gt;export1&lt;/name&gt;
    ...
&lt;/storage_domain&gt;
    </screen>

  </section>

  <section id="sect-REST_API_Guide-Storage_Domains-Listing">
    <title>
      Listing Export Storage Domain Contents
    </title>

    <para>
      Storage domains with <literal>type</literal> set to <literal>export</literal> contain <literal>vms</literal> and <literal>templates</literal> sub-collections which list the import candidate VMs and templates stored on that particular storage domain.
    </para>

    <para>
      VMs and templates in these collections have a similar representation to their counterparts in the top-level VMs and templates collection, except they also contain a <literal>storage_domain</literal> reference and an <literal>import</literal> action (see <xref linkend="sect-REST_API_Guide-VMs-Import"/>).
    </para>

    <screen>
GET /rhevm-api/datacenters/d70d5e2d-b8ad-494a-a4d2-c7a5631073c4/storagedomains/fabe0451-701f-4235-8f7e-e20e458819ed/vms
Accept: application/xml

&lt;vms&gt;
    &lt;vm id="082c794b-771f-452f-83c9-b2b5a19c0399"
      href="/rhevm-api/datacenters/d70d5e2d-b8ad-494a-a4d2-c7a5631073c4/storagedomains/
      fabe0451-701f-4235-8f7e-e20e458819ed/vms/082c794b-771f-452f-83c9-b2b5a19c0399"&gt;
        &lt;name&gt;vm1&lt;/name&gt;
        ...
        &lt;storage_domain id="082c794b-771f-452f-83c9-b2b5a19c0399"
          href="/rhevm-api/datacenters/d70d5e2d-b8ad-494a-a4d2-c7a5631073c4/storagedomains/
          fabe0451-701f-4235-8f7e-e20e458819ed"/&gt;
        &lt;actions&gt;
            &lt;link rel="import" href="/rhevm-api/datacenters/
              d70d5e2d-b8ad-494a-a4d2-c7a5631073c4/storagedomains/
              fabe0451-701f-4235-8f7e-e20e458819ed/vms/
              082c794b-771f-452f-83c9-b2b5a19c0399/import"/&gt;
        &lt;/actions&gt;
    &lt;/vm&gt;
&lt;/vms&gt;
    </screen>

  </section>

  <section id="sect-REST_API_Guide-Storage_Domains-Delete">
    <title>
      Deleting a Storage Domain
    </title>

    <para>
      A <literal>storage_domain</literal> reference must be passed in the body of a <literal>DELETE</literal> request for a storage domain. The <literal>storage_domain</literal> reference must be in the form:
    </para>
    <screen>
&lt;storage_domain&gt;
    &lt;host id="..."/&gt;
&lt;/storage_domain&gt;
    </screen>
    <para>
      OR
    </para>
    <screen>
&lt;storage_domain&gt;
    &lt;host&gt;
        &lt;name&gt;...&lt;/name&gt;
    &lt;/host&gt;
&lt;/storage_domain&gt;
    </screen>
    <para>
      Optionally, a <literal>format</literal> element may be passed to specify whether or not to format the storage domain after deletion. To format the storage domain after deletion:
    </para>
    <screen>
&lt;storage_domain&gt;
    &lt;host id="..."/&gt;
    &lt;format&gt;true&lt;/format&gt;
&lt;/storage_domain&gt;
    </screen>
    <para>  
      If no <literal>format</literal> element is passed, the storage domain will not be formatted.
    </para>
  </section>

  <section id="sect-REST_API_Guide-Storage_Domains-Activate">
    <title>
      Activate Action
    </title>

    <para>
      An attached storage domain must be activated before it the may be used. The activate action does not take any action specific parameters.
    </para>

    <screen>
POST /rhevm-api/datacenters/d70d5e2d-b8ad-494a-a4d2-c7a5631073c4/storagedomains/fabe0451-701f-4235-8f7e-e20e458819ed/activate HTTP/1.1
Content-type: application/xml
    </screen>

  </section>

  <section id="sect-REST_API_Guide-Storage_Domains-Deactivate">
    <title>
      Deactivate Action
    </title>

    <para>
      An attached storage domain must be deactivated before it can be removed. The deactivate action does not take any action specific parameters.
    </para>

    <screen>
POST /rhevm-api/datacenters/d70d5e2d-b8ad-494a-a4d2-c7a5631073c4/storagedomains/fabe0451-701f-4235-8f7e-e20e458819ed/deactivate HTTP/1.1
Content-type: application/xml
    </screen>

  </section>

</chapter>
